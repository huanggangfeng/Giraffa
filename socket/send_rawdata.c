#include <unistd.h>
#include <time.h>
#include <stdio.h>
#include <string.h>
#include <errno.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netpacket/packet.h>
#include <net/if.h>
#include <sys/stat.h>
#include <linux/if_ether.h>

#define ETHERTYPE  0x88F7 

unsigned char buf[] = { 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, // 0-5:  Dst mac address
   0xa0, 0x36, 0x9f, 0x10, 0xcf, 0xb1, // 6-11: src mac address 
   0x08, 0x00, // 12-13: IP  
   0x45, 0x00, // 14-15: IPV4, headlength 20 
   0x00, 0x80, // 16-17: length: 128
   0x64, 0x11, // 18-19: Identification 0x6411
   0x40, 0x00, // 20-21:Don't Fragment
   0x40, // 22: Time to live 
   0x11, // 23: Protocol: UDP(17)
   0x9c, 0xa0, // 24-25: Header Checksum
   0x0a, 0x90, 0x12, 0x4e, // 26-29: Src ip
   0x0a, 0x90, 0x12, 0x4e, // 30-33: Dst ip
   0xf0, 0x75, // 34-35: Src port: 61557
   0xf0, 0x76, // 36-37: Dst port: 61558
   0x00, 0x6c, // 38-39: Length
   0x39, 0xec, // 40-41: CheckSum
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

int main()
{
   int sendfd;
   int len; 
   int err;
   int datasize = 100;
   int i = 0;

   unsigned char *hwaddr;
   struct ifreq device;
   struct sockaddr_ll ifsock_addr;

   sendfd = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_IP));

   if (sendfd == -1) 
   {
      printf("Failed to open a socket!\n");
      return 0 ;
   }

   ifsock_addr.sll_family = AF_PACKET;
   ifsock_addr.sll_protocol = htons(ETH_P_IP);

   memset(&device, 0, sizeof(device));
   strcpy(device.ifr_name, "eth0");

   err = ioctl(sendfd,SIOCGIFINDEX,&device);
   ifsock_addr.sll_ifindex = device.ifr_ifindex;

   err = ioctl(sendfd, SIOCGIFHWADDR, &device);
   datasize = sizeof(buf);
   err = bind(sendfd, (struct sockaddr *)&ifsock_addr, sizeof(ifsock_addr));

   while (i < 10)
   {
      err = sendto(sendfd, buf, datasize, 0, (struct sockaddr *)&ifsock_addr, sizeof(ifsock_addr));
      if (err == -1)
         printf("Send fail, Errno is %d\n", errno);
      sleep(1);
      i++;
   }

   return 0;
}


